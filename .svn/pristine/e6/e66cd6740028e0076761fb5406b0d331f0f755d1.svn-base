/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import java.io.File;
import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.DecimalFormat;
import java.util.Calendar;
import java.util.logging.Level; 
import java.util.logging.Logger;
import jxl.Workbook;
import jxl.WorkbookSettings;
import jxl.write.WritableCellFormat;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import jxl.write.WriteException;
import jxl.format.Alignment;


/**
 *
 * @author informatica
 */
public class pfResumenPagos extends javax.swing.JPanel {
    
    private String prevision = "";
    private String impuesto = "";
    private String liquido = "";
    
    Calendar cal = Calendar.getInstance();
    DecimalFormat formateador = new DecimalFormat("###,###");
    int year  = cal.get(Calendar.YEAR);
    
    public pfResumenPagos() {
        
        initComponents();
        
    }
 
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        cbAgno = new javax.swing.JComboBox<String>();
        cbMes = new javax.swing.JComboBox<String>();
        btGenerar = new javax.swing.JButton();
        btCargar = new javax.swing.JButton();
        btLimpiar = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txPrevired = new javax.swing.JTextField();
        txImpuesto = new javax.swing.JTextField();
        txLiquido = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jLabel7 = new javax.swing.JLabel();

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        cbAgno.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "AÑO", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023", "2024", "2025", "2026", "2027", "2028" }));
        cbAgno.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbAgnoActionPerformed(evt);
            }
        });

        cbMes.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "MES", "ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE" }));
        cbMes.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbMesActionPerformed(evt);
            }
        });

        btGenerar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/write.png"))); // NOI18N
        btGenerar.setText("GENERAR");
        btGenerar.setEnabled(false);
        btGenerar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btGenerarActionPerformed(evt);
            }
        });

        btCargar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/Cargar.png"))); // NOI18N
        btCargar.setText("CARGAR");
        btCargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCargarActionPerformed(evt);
            }
        });

        btLimpiar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos/refresh16.png"))); // NOI18N
        btLimpiar.setText("LIMPIAR");
        btLimpiar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btLimpiarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(38, 38, 38)
                .addComponent(cbMes, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(cbAgno, javax.swing.GroupLayout.PREFERRED_SIZE, 91, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(46, 46, 46)
                .addComponent(btCargar, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(btGenerar, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(19, 19, 19)
                .addComponent(btLimpiar, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(16, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btGenerar)
                    .addComponent(cbAgno, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(cbMes, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btCargar)
                    .addComponent(btLimpiar, javax.swing.GroupLayout.PREFERRED_SIZE, 41, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(22, Short.MAX_VALUE))
        );

        jLabel1.setFont(new java.awt.Font("Arial", 1, 12)); // NOI18N
        jLabel1.setText("RESUMEN PAGOS");

        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel2.setText("Pagos Previsionales");

        jLabel3.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel3.setText("Pagos IMPUESTO UNICO");

        jLabel4.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        jLabel4.setText("Pagos SUELDO LIQUIDO");

        txPrevired.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txPrevired.setDisabledTextColor(new java.awt.Color(51, 51, 51));
        txPrevired.setEnabled(false);

        txImpuesto.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txImpuesto.setDisabledTextColor(new java.awt.Color(51, 51, 51));
        txImpuesto.setEnabled(false);

        txLiquido.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        txLiquido.setToolTipText("");
        txLiquido.setDisabledTextColor(new java.awt.Color(51, 51, 51));
        txLiquido.setEnabled(false);

        jLabel5.setText("$");

        jLabel6.setText("$");

        jLabel7.setText("$");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(77, 77, 77)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, 156, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 156, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 156, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel5, javax.swing.GroupLayout.PREFERRED_SIZE, 12, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, 12, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel7, javax.swing.GroupLayout.PREFERRED_SIZE, 12, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                            .addComponent(txImpuesto, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(txPrevired, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(txLiquido, javax.swing.GroupLayout.PREFERRED_SIZE, 97, javax.swing.GroupLayout.PREFERRED_SIZE)))
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(10, 10, 10)
                                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 148, javax.swing.GroupLayout.PREFERRED_SIZE))))
                .addContainerGap(18, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addGap(11, 11, 11)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(49, 49, 49)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel5, javax.swing.GroupLayout.PREFERRED_SIZE, 17, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txPrevired, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel2))
                .addGap(19, 19, 19)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(jLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, 17, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txImpuesto, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(19, 19, 19)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel4)
                    .addComponent(jLabel7, javax.swing.GroupLayout.PREFERRED_SIZE, 17, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txLiquido, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(50, 50, 50))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void cbAgnoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbAgnoActionPerformed

    }//GEN-LAST:event_cbAgnoActionPerformed

    private void cbMesActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbMesActionPerformed

    }//GEN-LAST:event_cbMesActionPerformed

    private void btGenerarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btGenerarActionPerformed
                
        if (cbMes.getSelectedIndex() == 0){

            fmMain.Mensaje("Debe elegir un Mes");
            return;
        }
        
        if (cbAgno.getSelectedIndex() == 0){

            fmMain.Mensaje("Debe elegir un Año");               
            return;
        }

        if(Integer.parseInt(cbAgno.getSelectedItem().toString()) > year){       //Si el año elegido es mayor al año en curso

            fmMain.Mensaje("Año fuera de rango!!");                              //El año está fuera de rango porque aún no hay registros.
            return;
        }
        
        if (txLiquido.getText().equals("") || txPrevired.getText().equals("") || txImpuesto.getText().equals("")) {
        
            fmMain.Mensaje("No existen datos cargados!!");                              //Si no se han cargado los datos.
            return;
        
        }
        
        btGenerar.setEnabled(false);
            
        File ruta = null;
        
        String sSistemaOperativo = System.getProperty("os.name");               //Determina el Sistema Operativo del Equipo
            
        if (sSistemaOperativo.contains("Win")){
        
            ruta = new File("C:\\Users\\informatica\\Desktop\\resumen"+cbMes.getSelectedItem()+cbAgno.getSelectedItem()+".xls");               
        
        }else{
            
            ruta = new File("/home/informatica/Escritorio/resumen"+cbMes.getSelectedItem()+cbAgno.getSelectedItem()+".xls");  
        }
        
        WorkbookSettings conf = new WorkbookSettings();
        conf.setEncoding("ISO-8859-1");                                     //Se establece la norma ISO de codificación de caracteres
           
        try {
            
            WritableWorkbook libro = Workbook.createWorkbook(ruta,conf);     //Se crea libro de excel
            
            WritableCellFormat format = new WritableCellFormat();               //Alineación para los encabezados
            format.setAlignment(Alignment.CENTRE);
            
            WritableCellFormat format2 = new WritableCellFormat();              //Alineación para los datos
            format2.setAlignment(Alignment.RIGHT);
            
            WritableSheet hoja = libro.createSheet("Resumen_Pagos", 0);     //Se le asigna nombre a la primera hoja(0) del libro excel
            hoja.setColumnView(0, 20);                                         //Ancho de la columna (en número de caracteres)
            hoja.setColumnView(1, 30);
            hoja.setColumnView(2, 30);
    //********************************  Se agregan contenido a las celdas de la hoja  *******************************************        
            hoja.addCell(new jxl.write.Label(0,0,"Pagos Previsionales",format));                
            hoja.addCell(new jxl.write.Label(1,0,"Pagos IMPUESTO ÚNICO",format));
            hoja.addCell(new jxl.write.Label(2,0,"Pagos SUELDO LIQUIDO",format));
            hoja.addCell(new jxl.write.Label(0,1,prevision,format2));
            hoja.addCell(new jxl.write.Label(1,1,impuesto,format2));
            hoja.addCell(new jxl.write.Label(2,1,liquido,format2));
    //***************************************************************************************************************************    
            libro.write();          //Se escriben el contenido en el libro
            libro.close();          //se cierra el libro
            
            fmMain.Mensaje("Archivo : "+cbMes.getSelectedItem()+cbAgno.getSelectedItem()+".xls \n creado con éxito");
            
        } catch (WriteException | IOException ex) {
            Logger.getLogger(pfResumenPagos.class.getName()).log(Level.SEVERE, null, ex);
        }
    

    }//GEN-LAST:event_btGenerarActionPerformed
    
    
    private void btCargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCargarActionPerformed
        
        btGenerar.setEnabled(true);             //45 255 6682
        
        ExeSql Sql = new ExeSql();
        ExeSql Sql2 = new ExeSql();
        ExeSql Sql3 = new ExeSql();
        
        ResultSet Rs, Rs2, Rs3;
        
        if (cbMes.getSelectedIndex() == 0){

            fmMain.Mensaje("Debe elegir un Mes");
            btGenerar.setEnabled(false);
            return;
        }
        
        if (cbAgno.getSelectedIndex() == 0){

            fmMain.Mensaje("Debe elegir un Año");
            btGenerar.setEnabled(false);
            return;
        }

        if(Integer.parseInt(cbAgno.getSelectedItem().toString()) > year){       //Si el año elegido es mayor al año en curso

            fmMain.Mensaje("Año fuera de rango!!");                             //El año está fuera de rango porque aún no hay registros.
            btGenerar.setEnabled(false);
            return;
        }
        
        try {
            
            Rs = Sql.Select("SELECT SUM(ps.totalapagar) AS liquido\n" +
                            "FROM psueldos ps\n" +
                            "LEFT JOIN personal p ON ps.rut = p.rut\n" +
                            "WHERE ps.agno = " + cbAgno.getSelectedItem() + " \n"+
                            "AND ps.mes = " +cbMes.getSelectedIndex() + " \n"+
                            "AND p.empresa = 1");
            
            if (Sql.GetRowCount() > 0){
             
                Rs.next();
                 
                txLiquido.setText(formateador.format(Rs.getDouble("liquido")));  
                 
                liquido = txLiquido.getText();
             
            }
             
//            Rs2 = Sql2.Select("SELECT SUM(ps.monto) AS previ\n" +
//                              "FROM psueldosdet ps\n" +
//                              "LEFT JOIN par_general pg ON ps.codigo = pg.codigo \n"+
//                              "LEFT JOIN personal p ON ps.rut = p.rut \n"+
//                              "WHERE ps.agno = " + cbAgno.getSelectedItem() + " \n"+
//                              "AND ps.mes = " +cbMes.getSelectedIndex() + " \n"+
//                              "AND ps.empresa = 1 \n" +
//                              "AND p.activo IS TRUE \n"+
//                              "AND ps.codigo IN ('5','6','12','13','14','15','16','17','18','21','22','23','24','25','29','33','34','42','43','44','63','64','65','74')"+
//                              "AND pg.tipo IN ('REM_DESCUENTOS','REM_HABERES','REM_OTROS')");
//            
            
            
              Rs2 = Sql2.Select("SELECT SUM(ps.monto) AS previ\n" +
                              "FROM psueldosdet ps\n" +
                              "LEFT JOIN par_general pg ON ps.codigo = pg.codigo \n"+
                              "LEFT JOIN personal p ON ps.rut = p.rut \n"+
                              "WHERE ps.agno = " + cbAgno.getSelectedItem() + " \n"+
                              "AND ps.mes = " +cbMes.getSelectedIndex() + " \n"+
                              "AND ps.empresa = 1 \n" +
                              "AND p.activo IS TRUE \n"+
                              "AND ps.codigo NOT IN ('19','20','27','31','78')"+
                              "AND pg.tipo IN ('REM_DESCUENTOS','REM_OTROS')");
             
            if (Sql2.GetRowCount() > 0){
             
                Rs2.next();
                 
                txPrevired.setText(formateador.format(Rs2.getDouble("previ")));
                prevision = txPrevired.getText();
             
            }
             
            Rs3 = Sql3.Select("SELECT SUM(ps.monto) AS impuesto \n" +
                              "FROM psueldosdet ps \n" +
                              "WHERE ps.agno = " + cbAgno.getSelectedItem() + " \n"+
                              "AND ps.mes = " +cbMes.getSelectedIndex() + " \n"+
                              "AND ps.empresa = 1 \n" +
                              "AND ps.codigo IN ('19')");
             
            if (Sql3.GetRowCount() > 0){
             
                Rs3.next();
                 
                txImpuesto.setText(formateador.format(Rs3.getDouble("impuesto")));
                impuesto = txImpuesto.getText();
             
            }
            
        } catch (SQLException ex) {
            Logger.getLogger(pfResumenPagos.class.getName()).log(Level.SEVERE, null, ex);
        }
        
    }//GEN-LAST:event_btCargarActionPerformed

    private void btLimpiarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btLimpiarActionPerformed
        cbAgno.setSelectedIndex(0);
        cbMes.setSelectedIndex(0);
        
        txLiquido.setText("");
        txPrevired.setText("");
        txImpuesto.setText("");
        
    }//GEN-LAST:event_btLimpiarActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    public javax.swing.JButton btCargar;
    public javax.swing.JButton btGenerar;
    public javax.swing.JButton btLimpiar;
    private javax.swing.JComboBox<String> cbAgno;
    private javax.swing.JComboBox<String> cbMes;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JTextField txImpuesto;
    private javax.swing.JTextField txLiquido;
    private javax.swing.JTextField txPrevired;
    // End of variables declaration//GEN-END:variables
}
